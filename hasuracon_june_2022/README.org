#+TITLE: Securing your GraphQL API with Hasura
#+SUBTITLE: HasuraCon 2022
#+AUTHOR: David A. Ventimiglia
#+EMAIL: davidaventimiglia@hasura.io

#+options: timestamp:nil title:t toc:nil todo:t |:t num:t author:nil

#+REVEAL_DEFAULT_SLIDE_BACKGROUND: ./slide_background.png
#+REVEAL_INIT_OPTIONS: transition:'none', controlsLayout:'edges', progress:false, controlsTutorial:false
#+REVEAL_THEME: black
#+REVEAL_TITLE_SLIDE_BACKGROUND: ./slide_background.png

* Introduction

*** Program

- Hasura API Limits
- Hasura Permissions
- Hasura Allow Lists
- Hasura REST Endpoints

#+begin_NOTES
This is a note
#+end_NOTES

*** Principles

- Risk Management :: /Life is about trade-offs./
- Goal Setting :: /Confidentiality, Integrity, Availability/
- Defense in Depth :: /Bottom-Up/
- Simplicity :: /Complexity is the Enemy of Security/
- Least Privilege :: /The most secure API does nothing at all./

*** Threats

- Deep Queries :: /Confidentiality, Availability/
- Recursive Queries :: /Availability/
- Unbounded Queries :: /Confidentiality, Availability/
- Batch Requests :: /Confidentiality, Availability/

*** Application

- [ ] +Secure the DB+
- [X] Secure the Service
- [ ] +Add Authentication+
- [ ] +Disable Hasura Console+
- [X] Disable Schema Introspection
- [X] Create a Securable Data Model
- [X] Set API Limits
- [X] Apply Permissions
- [X] Use Allow Lists
- [X] Create REST Endpoints

* Workshop

*** Setup: Log into Heroku

[[file:log_into_heroku.png]]

*** Setup: Log into Hasura Cloud

[[file:log_into_hasura_cloud.png]]

*** Setup: Create a new Hasura Cloud Project

[[file:create_new_hasura_project.png]]

*** Setup: Create a new Heroku database

*** Setup: Connect to the database (OPTIONAL)

#+begin_src shell :export both
  PGHOST=<hostname> PGPORT=<port> PGDATABASE=<db> PGUSER=<username> PGPASSWORD=<password> psql
  psql -h <hostname> -p <port> -d <db> -U <username> psql
  heroku pg:credentials:url -a <app>
  heroku psql -a <app>
#+end_src

*** Secure the DB (OPTIONAL)

- Create a dedicated DB user for PROD.
- ~REVOKE~ DML (maybe).
- ~REVOKE~ DDL (definitely).
- Use a [[https://hasura.io/docs/latest/graphql/core/getting-started/docker-simple/][separate dev instance]] with elevated permissions for data modeling.
- Use an env var like ~PG_DATABASE_URL~ with your Hasuras.

 #+begin_src sql
   -- Read-only? (not on Heroku hobby tier!)
   CREATE USER hasuraprod WITH PASSWORD 'hasuraprod';
   GRANT CONNECT ON DATABASE <db> TO hasuraprod;
   GRANT USAGE ON SCHEMA <schema> TO hasuraprod;
   GRANT SELECT ON ALL TABLES IN SCHEMA <schema> TO hasuraprod;
   GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA <schema> TO hasuraprod;
 #+end_src

*** Secure the Service

- ~HASURA_GRAPHQL_ADMIN_SECRET~

*** Add Authentication (OPTIONAL)

- ~HASURA_GRAPHQL_AUTH_HOOK~
- ~HASURA_GRAPHQL_AUTH_HOOK_MODE~

*** Disable Hasura Console (OPTIONAL)

- ~HASURA_GRAPHQL_ENABLE_CONSOLE~

*** Disable Schema Introspection

[[file:disable_schema_introspection.png]]

*** Create a Securable Data Model

*** Set API Limits

[[file:set_api_limits.png]]

*** Apply Permissions

*** Use Allow Lists

*** Create REST Endpoints

* Discussion

*** GraphQL Security Orthodoxy

AKA: rituals, cargo cults, security theater which you can get anywhere
- Disable Console Access
- Disable Schema Introspection
- Disable Query Suggestions (unneccessary in Hasura)
- Impose API Limits
- Whitelist Operations

*** GraphQL Security Heterodoxy

AKA: possibly controversial opinions which you will get from me
- Don't confuse public vs private:
- If you don't /need/ to provide a public API, then don't.
- If you're not providing a public API, then don't act like you are.
- Don't disable console access
- If you applied the security principles carefully, deliberately, thoughtfully, then the console can't do anything unauthorized anyway.
- Don't disable schema introspection and query suggestions.
- The public will need to know how to use your public API (which you almost certainly shouldn't have anyway)
- The public shouldn't have access to your private API (you did secure your API, add authentication, disable unauthorized access, build a rich data model, and apply fine-graned authorization, didn't you?)
- The information will get out anyway.
- Don't use GraphQL security
- Or at least, don't rely on it.
- Work diligently from the bottom-up, applying the principles carefully, deliberately, thoughtfully, and you (almost) won't need it.
- Remember "managing risk", "cargo cults", and "security theater".
Life is about trade-offs.
- Don't use GraphQL
- For private APIs, that is.
- Use Allow Lists.
- And if you're using Allow Lists, you might as well use REST endpoints.
- GraphQL is for /people/ (i.e. developers), not for machines.

* Closing Remarks

*** References

*** How and where to get help

white_check_mark
100
raised_hands
